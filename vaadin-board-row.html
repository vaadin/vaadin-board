<link rel="import" href="../polymer/polymer.html">
<script src="resizable.js"></script>

<dom-module id="vaadin-board-row">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: stretch;
      }

      :host ::slotted(*) {
        box-sizing: border-box;
        flex-grow: 1;
      }
    </style>
    <slot id="insertionPoint"></slot>
  </template>

  <script>
    class VaadinBoardRow extends Resizable(Polymer.Element){
      static get is() {
        return "vaadin-board-row";
      }
      constructor() {
        super();
        this._onIronResize = this._onIronResize.bind(this);
        this._ONE_COLUMN_MAX_WIDTH = 600;
        this._TWO_COLUMNS_MAX_WIDTH = 1000;
        this._oldWidth = 0;
        this._oldFlexBasis = [];
      }
      ready() {
        super.ready();
        this.addEventListener('iron-resize', this._onIronResize);
      }
      connectedCallback() {
        super.connectedCallback();
        Polymer.RenderStatus.afterNextRender(this, this._onIronResize);
      }
      /**
       * Calculates flex basis based on colSpan and width
       * @param{Number}
       * @param{Number}
       */
      _calculateFlexBasis(colSpan, width) {
        let flexBasis = 25 * colSpan;
        if (width < this._ONE_COLUMN_MAX_WIDTH) {
          flexBasis = 100;
        } else if (width < this._TWO_COLUMNS_MAX_WIDTH) {
          flexBasis = 50 * colSpan;
        }
        flexBasis = flexBasis > 100 ? 100 : flexBasis;
        return flexBasis + '%';
      }

      _createErrorMessage(nodeSpans) {
        let config = nodeSpans.reduce((a,b)=>{return a+"-"+b});
        let error ="The column configuration "+config+" is not valid; column count should add up to 3 or 4.";

        return error;
      }
      /**
       * If there is not enough space in the row.
       * Extra items are dropped from DOM.
       * @param{Array} array of node spans
       * @param{Array} array of nodes
       */
      _removeExtraNodesFromDOM(nodeSpans, nodes) {
        let isErrorReported=false;
        let spaceLeft=4;
        let returnNodes=[];
        nodes.forEach((node,i) => {
          spaceLeft = spaceLeft - nodeSpans[i];
          if(spaceLeft < 0) {
            if(!isErrorReported) {
              isErrorReported = true;
              console.warn(this._createErrorMessage(nodeSpans), "check: \r\n"+this.outerHTML);
            }
            this.removeChild(node);
          }
          else {
            returnNodes[i] = node;
          }
        });
        return returnNodes;
      }
      _onIronResize(e) {
        const width = this.getBoundingClientRect().width;
        if (width != this._oldWidth) {
          const nodes = this.$.insertionPoint.assignedNodes();
          const filteredNodes = nodes.filter(node => node.nodeType !== node.TEXT_NODE);
          const nodeSpans = filteredNodes.map(node => {
            if(node.getAttribute("board-cols")) {
              return parseInt(node.getAttribute("board-cols"));
            }
           return 1;
          });

          this._removeExtraNodesFromDOM(nodeSpans, filteredNodes).forEach((e,i)=> {
              let newFlexBasis = this._calculateFlexBasis(nodeSpans[i], width);
              if(!this._oldFlexBasis[i] || this._oldFlexBasis[i]!=newFlexBasis) {
                  this._oldFlexBasis[i] = newFlexBasis
                  e.style.flexBasis = newFlexBasis;
              }
          });
          this._oldWidth = width;
        }
      }
    }
    customElements.define(VaadinBoardRow.is, VaadinBoardRow);
  </script>
</dom-module>
